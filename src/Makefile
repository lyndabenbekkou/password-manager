CC = gcc
CFLAGS = -Wall -Wextra -Werror -std=c11 -pedantic -g
LDFLAGS = -lssl -lcrypto -lsqlite3

# Mode debug (ajouter -DDEBUG pour activer les prints de debug)
# CFLAGS += -DDEBUG

# R√©pertoires
SRC_DIR = .
OBJ_DIR = obj
BIN_DIR = .
TEST_DIR = test
COV_DIR = coverage


# Fichiers
TARGET = $(BIN_DIR)/password_manager
SOURCES = main.c crypto.c auth.c database.c
OBJECTS = $(SOURCES:%.c=$(OBJ_DIR)/%.o)
HEADERS = common.h config.h crypto.h auth.h database.h interface.h
TEST_UNIT_SRC = $(TEST_DIR)/test_unitaire.c
TEST_INT_SRC = $(TEST_DIR)/test_integration.c

# Ex√©cutables de test
TEST_UNIT_TARGET = $(BIN_DIR)/test_unitaire
TEST_INT_TARGET = $(BIN_DIR)/test_integration

# Objets n√©cessaires pour les tests
TEST_OBJECTS = $(filter-out $(OBJ_DIR)/main.o, $(OBJECTS))


# R√®gles principales
.PHONY: all clean run help test test_unit test_int

all: $(TARGET)


$(TARGET): $(OBJECTS)
	@echo "üîó Linking $(TARGET)..."
	$(CC) $(OBJECTS) -o $(TARGET) $(LDFLAGS)
	@echo "‚úÖ Build successful!"
	@echo "   Run with: ./password_manager"

$(OBJ_DIR)/%.o: $(SRC_DIR)/%.c $(HEADERS) | $(OBJ_DIR)
	@echo "üî® Compiling $<..."
	$(CC) $(CFLAGS) -c $< -o $@


$(OBJ_DIR):
	@mkdir -p $(OBJ_DIR)

# TESTS

$(TEST_UNIT_TARGET): $(TEST_UNIT_SRC) $(TEST_OBJECTS)
	@echo "üî® Compiling Unit Tests (with coverage)..."
	$(CC) $(CFLAGS) -I. $(TEST_UNIT_SRC) \
		crypto.c auth.c database.c -o $(TEST_UNIT_TARGET) $(LDFLAGS)


$(TEST_INT_TARGET): $(TEST_INT_SRC) $(TEST_OBJECTS)
	@echo "üî® Compiling Integration Tests (with coverage)..."
	$(CC) $(CFLAGS) -I. $(TEST_INT_SRC) \
		crypto.c auth.c database.c -o $(TEST_INT_TARGET) $(LDFLAGS)


test: $(TEST_UNIT_TARGET) $(TEST_INT_TARGET)
	@echo ""
	@echo "RUNNING UNIT TESTS AND INTEGRATION TESTS"
	@./$(TEST_UNIT_TARGET) 2>/dev/null || (echo "‚ùå Unit Tests Failed" && exit 1)
	@echo "‚úÖ Unit Tests Passed"
	@echo ""
	@./$(TEST_INT_TARGET) 2>/dev/null
	@echo "‚úÖ Integration Tests Passed" || (echo "‚ùå Integration Tests Failed" && exit 1)
	@echo ""
	@echo "üéâ ALL TESTS PASSED!"


test_unit: $(TEST_UNIT_TARGET)
	@./$(TEST_UNIT_TARGET)
	@echo ""

test_int: $(TEST_INT_TARGET)
	@./$(TEST_INT_TARGET)
	@echo ""



clean:
	@echo "üßπ Cleaning build files..."
	rm -rf $(OBJ_DIR)
	rm -f $(TARGET)
	rm -f $(TEST_UNIT_TARGET) $(TEST_INT_TARGET)
	rm -f password_manager.db test_suite.db test_integration.db *.gcda *.gcno *.gcov
	@echo "‚ú® Clean complete!"


run: $(TARGET)
	@echo "üöÄ Running password manager..."
	@echo ""
	./$(TARGET)

# Aide
help:
	@echo "üìñ Password Manager - Makefile Help"
	@echo ""
	@echo "Available targets:"
	@echo "  make              - Compile le projet"
	@echo "  make all          - Compile le projet"
	@echo "  make clean        - Nettoie les fichiers compil√©s"
	@echo "  make run          - Compile et ex√©cute"
	@echo "  make help     	   - Affiche cette aide"
	@echo "  make test         - Lance tous les tests"
	@echo "  make test_unit    - Lance uniquement les tests unitaires"
	@echo "  make test_int     - Lance uniquement les tests d'int√©gration"
	@echo ""
	@echo "Debug mode:"
	@echo "  make CFLAGS+='-DDEBUG' - Compile avec debug prints"
	@echo ""
	@echo "Dependencies:"
	@echo "  - OpenSSL (libssl-dev)"
	@echo "  - SQLite3 (libsqlite3-dev)"


.PHONY: check valgrind
